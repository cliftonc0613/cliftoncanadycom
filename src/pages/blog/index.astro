---
import { getCollection } from 'astro:content';
import { Star, BookOpen } from 'lucide-react';
import Layout from '@/layouts/Layout.astro';
import Navigation from '@/components/Navigation.astro';
import Footer from '@/components/Footer.astro';
import BlogHero from '@/components/BlogHero.astro';
import BlogCard from '@/components/BlogCard.astro';

// Get all blog posts
const allPosts = await getCollection('blog', ({ data }) => {
  // In production, exclude drafts and check publishDate
  if (import.meta.env.PROD) {
    // Exclude drafts
    if (data.draft) return false;

    // Check if pubDate has passed (if set)
    if (data.pubDate) {
      const pubDate = new Date(data.pubDate);
      const now = new Date();
      return pubDate <= now;
    }

    return true;
  }

  // In development, include all posts
  return true;
});

// Sort posts by date (newest first)
const sortedPosts = allPosts.sort((a, b) =>
  new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf()
);

// Separate featured and regular posts
const featuredPosts = sortedPosts.filter(post => post.data.featured).sort((a, b) =>
  new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf()
);
const regularPosts = sortedPosts.filter(post => !post.data.featured);

// Category badge colors
const categoryColors: Record<string, { bg: string; text: string }> = {
  'WordPress Development': { bg: 'bg-blue-100', text: 'text-blue-900' },
  'Content Writing': { bg: 'bg-green-100', text: 'text-green-900' },
  'AI Training': { bg: 'bg-purple-100', text: 'text-purple-900' },
  'Speaking': { bg: 'bg-orange-100', text: 'text-orange-900' },
  'Photography': { bg: 'bg-pink-100', text: 'text-pink-900' },
  'General': { bg: 'bg-gray-100', text: 'text-gray-900' }
};

// Format date
function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

// Get category color
function getCategoryColor(category: string) {
  return categoryColors[category] || categoryColors['General'];
}
---

<Layout title="Blog - Insights on WordPress, AI, Content & More" description="Explore articles on WordPress development, AI training, content strategy, speaking, and professional insights from Clifton T. Canady.">
  <!-- Navigation Header -->
  <Navigation />

  <!-- Hero Section with new BlogHero component -->
  <BlogHero postCount={sortedPosts.length} />

  <div class="bg-white">
    <!-- Featured Posts Section -->
    {featuredPosts.length > 0 && (
      <section class="py-16 px-4" id="featured">
        <div class="container mx-auto max-w-4xl">
          <h2 class="text-4xl font-black font-[Poppins] text-foreground mb-12 px-4 flex items-center gap-3">
            <Star class="w-10 h-10 text-orange-500 fill-orange-500" />
            Featured Articles
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-16 px-4">
            {featuredPosts.map(post => (
              <BlogCard
                title={post.data.title}
                description={post.data.description}
                pubDate={post.data.pubDate}
                category={post.data.category}
                slug={post.slug}
                image={post.data.image}
                featured={true}
              />
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- All Posts Section -->
    <section class={`py-16 px-4 ${featuredPosts.length > 0 ? 'bg-gray-50' : 'bg-white'}`}>
      <div class="container mx-auto">
        <h2 class="text-4xl font-black font-[Poppins] text-foreground mb-12 px-4 flex items-center gap-3">
          <BookOpen class="w-10 h-10 text-blue-600" />
          {featuredPosts.length > 0 ? 'More Articles' : 'Latest Articles'}
        </h2>
        {regularPosts.length > 0 ? (
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 px-4">
            {regularPosts.map(post => (
              <BlogCard
                title={post.data.title}
                description={post.data.description}
                pubDate={post.data.pubDate}
                category={post.data.category}
                slug={post.slug}
                image={post.data.image}
                featured={false}
              />
            ))}
          </div>
        ) : (
          <div class="text-center py-16 px-4">
            <p class="text-gray-600 text-lg font-[Roboto_Mono]">
              No articles published yet. Check back soon!
            </p>
          </div>
        )}
      </div>
    </section>

    <!-- Newsletter CTA Section -->
    <section class="py-24 px-4 bg-gray-50" id="newsletter">
      <div class="container mx-auto max-w-2xl text-center">
        <h2 class="text-3xl md:text-4xl font-black font-[Poppins] text-foreground mb-4">
          Never miss an update
        </h2>
        <p class="text-gray-600 font-[Roboto_Mono] mb-8 max-w-lg mx-auto">
          Get new articles, strategies, and insights delivered to your inbox.
        </p>
        
        <form id="newsletter-form" class="flex flex-col sm:flex-row gap-4 max-w-md mx-auto">
          <input 
            type="email" 
            id="newsletter-email"
            name="email"
            required 
            class="w-full px-5 py-3 bg-white border-2 border-gray-200 rounded-md text-foreground placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
            placeholder="Enter your email address"
          />
          <button 
            type="submit" 
            id="newsletter-submit-btn"
            class="w-full sm:w-auto px-8 py-3 bg-primary hover:bg-primary/90 text-primary-foreground font-bold rounded-md transition-all duration-300 whitespace-nowrap"
          >
            <span id="newsletter-submit-text">Subscribe</span>
            <span id="newsletter-loading-text" style="display:none;">Subscribing...</span>
          </button>
        </form>
        
        <div id="newsletter-form-message" class="mt-4 text-center" style="display:none;"></div>
      </div>
    </section>
  </div>

  <!-- Footer -->
  <Footer />
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('newsletter-form') as HTMLFormElement;
    const submitBtn = document.getElementById('newsletter-submit-btn') as HTMLButtonElement;
    const submitText = document.getElementById('newsletter-submit-text') as HTMLSpanElement;
    const loadingText = document.getElementById('newsletter-loading-text') as HTMLSpanElement;
    const messageDiv = document.getElementById('newsletter-form-message') as HTMLDivElement;
    const emailInput = document.getElementById('newsletter-email') as HTMLInputElement;

    if (form) {
      form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const email = emailInput.value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showMessage('Please enter a valid email address.', 'error');
          return;
        }

        setLoadingState(true);

        try {
          const response = await fetch('https://services.leadconnectorhq.com/hooks/O3A0THtKcMOzi34vEwru/webhook-trigger/m5542gbRcwVmRY8S0Rl2', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email, source: 'Blog Newsletter' })
          });

          if (response.ok) {
            showMessage('Thank you for subscribing!', 'success');
            form.reset();
          } else {
            throw new Error('Submission failed');
          }
        } catch (error) {
          console.error('Newsletter submission error:', error);
          showMessage('Something went wrong. Please try again.', 'error');
        } finally {
          setLoadingState(false);
        }
      });
    }

    function setLoadingState(loading: boolean) {
      if (loading) {
        submitBtn.disabled = true;
        submitText.style.display = 'none';
        loadingText.style.display = 'inline';
        submitBtn.classList.add('opacity-75');
      } else {
        submitBtn.disabled = false;
        submitText.style.display = 'inline';
        loadingText.style.display = 'none';
        submitBtn.classList.remove('opacity-75');
      }
    }

    function showMessage(message: string, type: 'success' | 'error') {
      messageDiv.textContent = message;
      messageDiv.className = `mt-4 text-center px-4 py-2 rounded-lg ${
        type === 'success' 
          ? 'bg-green-100 text-green-900 border border-green-200' 
          : 'bg-red-100 text-red-900 border border-red-200'
      }`;
      messageDiv.style.display = 'block';

      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 5000);
    }
  });
</script>
